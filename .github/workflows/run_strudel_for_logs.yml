name: run-e2e-tests-on-docker
# source: https://github.com/marketplace/actions/install-poetry-action


on:
  push:
    branches: [ "main" ]

jobs:
  e2e-tests-docker:
    runs-on: ubuntu-22.04
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clone the Strudel manager Repository
        run: |
          echo $PWD
          export current_dir=$(pwd)
          cd /tmp
          git clone https://github.com/strudel-ai/strudel-public.git
          cd strudel-public
          ls -alt
          cd $current_dir
          echo $PWD
      - name: Install python
        uses: actions/setup-python@v5
        with:
         python-version: '3.10.12'


      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.STRUDEL_ECR_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.STRUDEL_ECR_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        
      - name: run docker compose
        run: |
            docker compose -f docker_compose_run.yml up -d
            sleep 6

      - name: run strudel sanity test
        run: |
            echo "start sanity test"
            export STATUSCODE=$(curl --silent --output /dev/stderr --write-out "%{http_code}" --location '127.0.0.1:8080/add_logs/' \
            --header 'X-Request-Id: 7' \
            --header 'Content-Type: application/json' \
            --data '{"source": "test",
            "file_content": "def foo():\n  print(a)",
            "file_name": "test"}')
            printf "\n\n****   status code is $STATUSCODE \n\n"
            if [ $STATUSCODE -ne 200 ]; then echo "sanity test fails, status $STATUSCODE"; fi
            if [ $STATUSCODE -ne 200 ]; then exit 22; fi
            echo "**** end sanity test"
            echo "**** end run strudel"

      - name: Get changed files
        id: get-changed-files
        uses: tj-actions/changed-files@v45
        # To compare changes between the current commit and the last pushed remote commit set `since_last_remote_commit: true`. e.g
        with:
          since_last_remote_commit: true

      - name: List all changed files
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "all changed files: $ALL_CHANGED_FILES"

